<!DOCTYPE html>
<html>
<head>
  <title>Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body>
<div class="app">

  <header>
    <h3>Chats</h3>
    <small id="myCode"></small>
  </header>

  <button class="newBtn" onclick="newChat()">New Chat</button>

  <div id="chatList"></div>

</div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyAI5nA49KkR5VsPn3QpjWOdM0lv2nEQu3U",
  authDomain: "private-chat-app-2986d.firebaseapp.com",
  projectId: "private-chat-app-2986d"
});
const db = firebase.firestore();

/* ---------- USER CODE ---------- */
let myCode = localStorage.getItem("code");
if (!myCode) {
  myCode = "U-" + Math.random().toString(36).substr(2,5);
  localStorage.setItem("code", myCode);
}
myCodeEl.innerText = "Your code: " + myCode;

/* ---------- REALTIME CHAT LIST ---------- */
db.collection("chats")
  .where("users", "array-contains", myCode)
  .onSnapshot(snap => {
    chatList.innerHTML = "";

    snap.forEach(doc => {
      const data = doc.data();
      const other = data.users.find(u => u !== myCode);

      const div = document.createElement("div");
      div.className = "chat";
      div.innerHTML = `<b>${other}</b><br><small>${data.last || ""}</small>`;

      div.onclick = () => {
        location.href = "chat.html?id=" + doc.id;
      };

      // ðŸ”¥ Long press delete chat
      let timer;
      div.addEventListener("touchstart", () => {
        timer = setTimeout(() => {
          if (confirm("Delete this chat?")) {
            db.collection("chats").doc(doc.id).delete();
          }
        }, 600);
      });
      div.addEventListener("touchend", () => clearTimeout(timer));
      div.addEventListener("touchmove", () => clearTimeout(timer));

      chatList.appendChild(div);
    });
  });

/* ---------- NEW CHAT ---------- */
function newChat() {
  const other = prompt("Enter user code");
  if (!other) return;

  const chatId = [myCode, other].sort().join("__");

  db.collection("chats").doc(chatId).set({
    users: [myCode, other],
    last: "",
    time: Date.now()
  }, { merge: true });

  location.href = "chat.html?id=" + chatId;
}
</script>
</body>
</html>
