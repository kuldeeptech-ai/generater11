<!DOCTYPE html>
<html>
<head>
  <title>Private Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#22c55e">

  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/906/906361.png">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body>
<div class="app">

  <header>
    <div>
      <h3 id="username"></h3>
      <small id="myCode"></small>
    </div>
    <button class="miniBtn" onclick="changeUsername()">Edit</button>
  </header>

  <button class="newBtn" onclick="newChat()">New Chat</button>

  <div id="chatList"></div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAI5nA49KkR5VsPn3QpjWOdM0lv2nEQu3U",
  authDomain: "private-chat-app-2986d.firebaseapp.com",
  projectId: "private-chat-app-2986d"
});
const db = firebase.firestore();

/* USER CODE */
let myCode = localStorage.getItem("code");
if (!myCode) {
  myCode = "U-" + Math.random().toString(36).substr(2,5);
  localStorage.setItem("code", myCode);
}
myCodeEl.innerText = "Code: " + myCode;

/* USERNAME */
let username = localStorage.getItem("username");
if (!username) {
  username = prompt("Enter username") || "User";
  localStorage.setItem("username", username);
}
usernameEl.innerText = username;

function changeUsername() {
  const n = prompt("New username");
  if (n) {
    localStorage.setItem("username", n);
    location.reload();
  }
}

/* CHAT LIST */
db.collection("chats")
  .where("users", "array-contains", myCode)
  .onSnapshot(snap => {
    chatList.innerHTML = "";

    snap.forEach(doc => {
      const data = doc.data();
      const other = data.users.find(u => u !== myCode);

      const div = document.createElement("div");
      div.className = "chat";
      div.innerHTML = `
        <b>${other}</b><br>
        <small>Chat ID: ${doc.id}</small><br>
        <small>${data.last || ""}</small>
      `;

      div.onclick = () => {
        location.href = "chat.html?id=" + doc.id;
      };

      // long press delete
      let t;
      div.addEventListener("touchstart", () => {
        t = setTimeout(() => {
          if (confirm("Delete chat?")) {
            db.collection("chats").doc(doc.id).delete();
          }
        }, 600);
      });
      div.addEventListener("touchend", () => clearTimeout(t));

      chatList.appendChild(div);
    });
  });

function newChat() {
  const other = prompt("Enter user code");
  if (!other) return;

  const chatId = [myCode, other].sort().join("__");

  db.collection("chats").doc(chatId).set({
    users: [myCode, other],
    last: "",
    time: Date.now()
  }, { merge: true });

  location.href = "chat.html?id=" + chatId;
}

/* PWA */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>