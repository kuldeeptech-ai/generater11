<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#22c55e">

  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body>
<div class="app">

  <header>
    <button onclick="goHome()">Back</button>
    <h3 id="chatWith"></h3>
  </header>

  <div id="messages"></div>

  <div class="send">
    <input id="msg" placeholder="Message">
    <button onclick="send()">Send</button>
  </div>

</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAI5nA49KkR5VsPn3QpjWOdM0lv2nEQu3U",
  authDomain: "private-chat-app-2986d.firebaseapp.com",
  projectId: "private-chat-app-2986d"
});
const db = firebase.firestore();

if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

const myCode = localStorage.getItem("code");
const params = new URLSearchParams(location.search);
const chatId = params.get("id");

const parts = chatId.split("__");
const other = parts[0] === myCode ? parts[1] : parts[0];
chatWith.innerText = other;

db.collection("chats").doc(chatId)
  .collection("messages")
  .orderBy("time")
  .onSnapshot(snap => {
    messages.innerHTML = "";

    snap.forEach(d => {
      const m = d.data();
      const div = document.createElement("div");
      div.className = m.from === myCode ? "me" : "them";
      div.innerText = m.text;

      if (document.hidden && m.from !== myCode) {
        new Notification("New message", { body: m.text });
      }

      let t;
      div.addEventListener("touchstart", () => {
        t = setTimeout(() => {
          if (confirm("Delete message?")) d.ref.delete();
        }, 600);
      });
      div.addEventListener("touchend", () => clearTimeout(t));

      messages.appendChild(div);
    });

    messages.scrollTop = messages.scrollHeight;
  });

function send() {
  if (!msg.value) return;

  db.collection("chats").doc(chatId)
    .collection("messages")
    .add({
      from: myCode,
      text: msg.value,
      time: Date.now()
    });

  db.collection("chats").doc(chatId).set({
    users: [myCode, other],
    last: msg.value,
    time: Date.now()
  }, { merge: true });

  msg.value = "";
}

function goHome() {
  location.href = "index.html";
}
</script>
</body>
</html>